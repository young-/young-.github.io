<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>创建NGINX重写规则 | 天青色等烟雨</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.2"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-87247047-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">创建NGINX重写规则</h1><a id="logo" href="/.">天青色等烟雨</a><p class="description">文不在多、有换则新、人不在挤、有来就行</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">创建NGINX重写规则</h1><div class="post-meta">Apr 26, 2018<span> | </span><span class="category"><a href="/categories/nginx/">nginx</a></span></div><div class="post-content"><p>在这篇文章中，我们讨论如何创建NGINX重写规则return, rewrite,和try_files指令。</p>
<a id="more"></a>
<p><ul class="markdownIt-TOC">
<li><a href="#%E5%AF%B9%E6%AF%94return-rewrite%E5%92%8Ctry_files%E6%8C%87%E4%BB%A4">对比return, rewrite,和try_files指令</a>
<ul>
<li><a href="#return%E6%8C%87%E4%BB%A4">return指令</a></li>
<li><a href="#rewrite%E6%8C%87%E4%BB%A4">rewrite指令</a>
<ul>
<li><a href="#rewrtie%E5%9B%9B%E7%A7%8Dflag">rewrtie四种flag</a></li>
</ul>
</li>
<li><a href="#try_files-%E6%8C%87%E4%BB%A4">try_files 指令</a></li>
</ul>
</li>
<li><a href="#%E7%A4%BA%E4%BE%8B-%E6%A0%87%E5%87%86%E5%8C%96%E5%9F%9F%E5%90%8D">示例 – 标准化域名</a>
<ul>
<li><a href="#%E4%BB%8E%E6%97%A7%E7%9A%84%E5%90%8D%E7%A7%B0%E9%87%8D%E5%AE%9A%E5%90%91%E5%88%B0%E6%96%B0%E7%9A%84%E5%90%8D%E7%A7%B0">从旧的名称重定向到新的名称</a></li>
<li><a href="#%E6%B7%BB%E5%8A%A0%E5%92%8C%E5%88%A0%E9%99%A4www%E5%89%8D%E7%BC%80">添加和删除www前缀</a></li>
<li><a href="#%E9%87%8D%E5%AE%9A%E5%90%91%E6%89%80%E6%9C%89%E7%9A%84%E6%B5%81%E9%87%8F%E5%88%B0%E6%AD%A3%E5%B8%B8%E7%9A%84%E5%9F%9F%E5%90%8D">重定向所有的流量到正常的域名</a></li>
</ul>
</li>
<li><a href="#%E7%A4%BA%E4%BE%8B%E5%BC%BA%E5%88%B6%E6%89%80%E6%9C%89%E8%AF%B7%E6%B1%82%E4%BD%BF%E7%94%A8-ssltls">示例：强制所有请求使用 SSL/TLS</a></li>
<li><a href="#%E7%A4%BA%E4%BE%8B-%E4%B8%BAwordpress%E7%BD%91%E7%AB%99%E5%90%AF%E7%94%A8%E6%BC%82%E4%BA%AE%E7%9A%84%E5%9B%BA%E5%AE%9A%E9%93%BE%E6%8E%A5">示例 – 为WordPress网站启用漂亮的固定链接</a></li>
<li><a href="#%E7%A4%BA%E4%BE%8B-%E4%B8%A2%E5%BC%83%E4%B8%8D%E5%8F%97%E6%94%AF%E6%8C%81%E7%9A%84%E6%96%87%E4%BB%B6%E6%89%A9%E5%B1%95%E5%90%8D%E7%9A%84%E8%AF%B7%E6%B1%82">示例 – 丢弃不受支持的文件扩展名的请求</a></li>
<li><a href="#%E7%A4%BA%E4%BE%8B-%E9%85%8D%E7%BD%AE%E8%87%AA%E5%AE%9A%E4%B9%89%E9%87%8D%E6%96%B0%E8%B7%AF%E7%94%B1">示例 – 配置自定义重新路由</a></li>
</ul>
</p>
<p>重写规则会更改客户请求中的部分或全部网址，通常用于以下两个目的之一：</p>
<ul>
<li><strong>通知客户端他们请求的资源现在位于不同的位置。</strong><br>
示例用例是您的网站的域名发生更改时，您希望客户端使用规范网址格式（带或不带www前缀），以及当您想要捕获和更正您的域名的常见拼写错误时。 返回和重写指令适合于这些目的。</li>
<li><strong>控制NGINX和NGINX Plus中的处理流程。</strong><br>
例如，在需要动态生成内容时，将请求转发到应用程序服务器。 try_files指令通常用于此目的。</li>
</ul>
<p><em>注意：学习如何转换Apache重写规则到Nginx重写规则，查看另一片文章<br>
Converting Apache Rewrite Rules to NGINX Rewrite Rules.<br>
我们假设你已经熟悉HTTP响应码及正则表达式相关知识（nginx和nginx plus使用Perl语法）。</em></p>
<h2><span id="对比return-rewrite和try_files指令"> 对比return, rewrite,和try_files指令</span></h2>
<p>通用NGINX重写的两个指令是return 和 rewrite，而try_files指令是将请求定向到应用程序服务器的一种方便的方法。 让我们回顾一下指令的作用以及它们之间的区别。</p>
<h3><span id="return指令"> return指令</span></h3>
<p>return指令是两个通用指令中的更简单的，因此我们建议在可能的情况下使用它而不是rewrite（更多的是为什么和什么时候）。 将返回值放在指定要重写的URL的服务器或位置上下文中，并定义客户端在将来对资源的请求中使用的已更正（重写）的URL。</p>
<p>这有一个简单的示例，重定向客户端到一个新的域名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name www.old-name.com;</span><br><span class="line">    return 301 $scheme://www.new-name.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>listen指令意味着server 块应用于HTTP和HTTPS流量。</li>
<li>server_name指令匹配具有域名www.old-name.com的请求URL。 - return指令告诉NGINX停止处理请求，并立即向客户端发送代码301（Moved Permanently）和指定的重写URL。 - 重写的URL使用两个NGINX变量来捕获和复制原始请求URL中的值</li>
<li>$ scheme是协议（http或https）</li>
<li>$ request_uri是包含参数的完整URI</li>
</ul>
<p>对于3xx系列中的代码，url参数定义新的（重写的）URL。<br>
<code>return (301 | 302 | 303 | 307) url;</code><br>
对于其他的代码，你可以选择定义一个用于显示在响应正文的文本字符串（HTTP代码的标准文本，例如404的Not Found，仍包含在标题中）。这个文本字符串可以包含nginx变量。<br>
<code>return (1xx | 2xx | 4xx | 5xx) [&quot;text&quot;];</code><br>
如下，对于非法的认证，当拒绝请求时返回的内容：<br>
<code>return 401 &quot;Access denied because token is expired or invalid&quot;;</code><br>
还有一些可以使用的语法快捷方式，例如省略302的代码; 请参阅return指令的参考文档。<br>
（在某些情况下，您可能希望返回一个比在文本字符串中可以实现的更复杂或更细微的响应。使用error_page指令，您可以为每个HTTP代码返回完整的自定义HTML页面，以及更改 响应代码或执行重定向。）<br>
所以 <strong>return指令使用很简单，适合当重定向满足两个条件：重写的URL适合于每个匹配server 或location 的请求，您可以使用标准的NGINX变量构建重写的URL。</strong></p>
<h3><span id="rewrite指令"> rewrite指令</span></h3>
<p>但是，如果你需要测试更复杂的URL之间的区别，捕获原始URL中没有相应的NGINX变量的元素，或者更改或添加路径中的元素，怎么办？ 在这种情况下，可以使用rewrite伪指令。</p>
<p>类似return指令，在server或这两个指令与类似的更加不同，并且rewrite指令可能更复杂地使用正确。<br>
它的语法很简单：在server 或location块中添加rewrite指令用于定义重定向的URL。另外，这两个指令与类似的更加不同，并且rewrite指令要使用正确可能更复杂。它的语法很简单：</p>
<p><code>rewrite regex URL [flag];</code></p>
<ul>
<li>第一个参数regex意味着NGINX Plus和NGINX只有在匹配指定的正则表达式（除了匹配server 或location - 指令之外）才重写URL。 附加测试意味着NGINX必须做更多的处理。</li>
<li>第二个不同是rewrite指令只能返回301或302代码。要返回其他的代码，你需要在rewrite指令之后包含一个return指令（看- 下面的例子）。</li>
<li>最后，rewrite指令不一定会阻止NGINX对返回请求的处理，并且不一定向客户端发送重定向。</li>
</ul>
<p>除非你明确指出（使用标志或URL的语法）你希望NGINX停止处理或发送重定向，它运行通过整个配置寻找在Rewrite模块中定义的指令（break，if，return，rewrite ，set），并按顺序处理它们。 如果重写的URL与重写模块中的后续指令匹配，NGINX对重写的URL执行指示的操作（通常再次重写）。<br>
这就是让人疑惑的地方，你需要仔细计划如何编写指令以获得所需的结果。 例如，如果原始location和NGINX重写规则在其中匹配重写的URL，NGINX可以进入一个循环，应用重写覆盖到内置的限制10次。 要了解所有详细信息，请参阅Rewrite模块的文档。 如前所述，我们建议尽可能使用return指令。<br>
下面是一个使用rewrite指令的nginx重写规则。他匹配以 /download起始的字符串，后面跟/media/  或者 /audio/  目录及后面其他的内容。他使用/mp3/ 和增加文件扩展名.mp3 或者.ra 替换以上的元素. $1 和 $2 变量捕获不变的路径元素。例如，/download/cdn-west/media/file1 变为 /download/cdn-west/mp3/file1.mp3.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    rewrite ^(/download/.*)/media/(.*)\..*$ $1/mp3/$2.mp3 last;</span><br><span class="line">    rewrite ^(/download/.*)/audio/(.*)\..*$ $1/mp3/$2.ra  last;</span><br><span class="line">    return  403;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们上面提到你可以添加标志到rewrite指令来控制处理的流程。 示例中的最后一个标志是其中之一：它指示NGINX跳过当前服务器或位置块中的任何后续Rewrite-module伪指令，并开始搜索与重写的URL匹配的新位置。<br>
在这个例子中的最终return指令意味着如果URL不匹配rewrite指令，代码403返回到客户端。</p>
<h4><span id="rewrtie四种flag"> rewrtie四种flag</span></h4>
<p>对于rewrtie有四种不同的flag，分别是redirect、permanent、break和last。<br>
其中前两种是跳转型的flag，后两种是代理型。跳转型是指有客户端浏览器重新对新地址进行请求，代理型是在WEB服务器内部实现跳转的。</p>
<ul>
<li>redirect：302跳转到rewrtie后面的地址。</li>
<li>permanent：301永久调整到rewrtie后面的地址，即当前地址已经永久迁移到新地址，一般是为了对搜索引擎友好。</li>
<li>last：<mark>将rewrite后的地址重新在server标签执行。</mark></li>
<li>break：<mark>将rewrite后地址重新在当前的location标签执行。</mark></li>
</ul>
<h3><span id="try_files-指令"> try_files 指令</span></h3>
<p>类似return和 rewrite指令，try_files  指令位于server和location块中。它需要一个或多个文件和目录以及最终URI的列表作为参数：</p>
<p><code>try_files file … uri;</code></p>
<p>NGINX按顺序检查文件和目录的存在（从 root 和alias指令的设置构造每个文件的完整路径），并提供它找到的第一个。 要指定目录，请在元素名称的末尾添加一个斜杠。 如果没有文件或目录存在，NGINX将执行内部重定向到由最后一个元素（uri）定义的URI。</p>
<p>为了使try_files指令正常工作，您还需要定义一个捕获内部重定向的location 块，如下面的示例所示。 最终元素可以是命名位置，由初始at符号（@）指示。</p>
<p>try_files指令通常使用$uri 变量，它表示域名后的URL部分。</p>
<p>在以下示例中，如果客户端请求的文件不存在，则NGINX提供默认的GIF文件。 当客户端请求（例如）<a href="http://www.domain.com/images/image1.gif%E6%97%B6%EF%BC%8CNGINX%E9%A6%96%E5%85%88%E5%9C%A8%E7%94%B1%E6%A0%B9%E6%88%96alias%E6%8C%87%E4%BB%A4%E6%8C%87%E5%AE%9A%E7%9A%84%E6%9C%AC%E5%9C%B0%E7%9B%AE%E5%BD%95%E4%B8%AD%E6%9F%A5%E6%89%BE%E9%80%82%E7%94%A8%E4%BA%8E%E8%AF%A5%E4%BD%8D%E7%BD%AE%E7%9A%84%E5%9B%BE%E5%83%8F%EF%BC%88%E6%9C%AA%E7%A4%BA%E5%87%BA%EF%BC%89" target="_blank" rel="noopener">http://www.domain.com/images/image1.gif时，NGINX首先在由根或alias指令指定的本地目录中查找适用于该位置的图像（未示出）</a> 在代码段中）。 如果image1.gif不存在，NGINX寻找image1.gif /，如果不存在，它会重定向到/images/default.gif。 该值与第二个位置指令完全匹配，因此处理停止，NGINX提供该文件并将其标记为缓存30秒。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /images/ &#123;</span><br><span class="line"> try_files $uri $uri/ /images/default.gif;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">location = /images/default.gif &#123;</span><br><span class="line"> expires 30s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="示例-标准化域名"> 示例 – 标准化域名</span></h2>
<p><strong>NGINX重写规则最常见的用途之一是捕获弃用或非标准版本的网站域名，并将其重定向到当前域名。</strong> 有几个相关的用例。</p>
<h3><span id="从旧的名称重定向到新的名称"> 从旧的名称重定向到新的名称</span></h3>
<p>此示例NGINX重写规则将请求从 <a href="http://www.old-name.com" target="_blank" rel="noopener">www.old-name.com</a> 和 <a href="http://old-name.com" target="_blank" rel="noopener">old-name.com</a> 永久重定向到 <a href="http://www.new-name.com" target="_blank" rel="noopener">www.new-name.com</a> ，使用的两个NGINX变量是从原始请求URL中捕获的值。 scheme是原始协议 （http或https），request_uri是完整的URI（域名后），包括参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name www.old-name.com old-name.com;</span><br><span class="line">    return 301 $scheme://www.new-name.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为$ request_uri捕获了域名后面的URL的部分，所以如果新旧网站之间存在一一对应的页面，则此重写是合适的（例如， <a href="http://www.new-name.com/about" target="_blank" rel="noopener">www.new-name.com/about</a>  与 <a href="http://www.old-name.com/about" target="_blank" rel="noopener">www.old-name.com/about</a> 相同的基本内容）。<br>
如果您在更改域名之外重新组织了网站，则可以通过省略 $request_uri来将所有请求重定向到主页，这样更安全：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name www.old-name.com old-name.com;</span><br><span class="line">    return 301 $scheme://www.new-name.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一些其他关于在NGINX中重写URL的博客对这些用例使用rewrite指令，像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># NOT RECOMMENDED</span><br><span class="line">rewrite ^ $scheme://www.new-name.com$request_uri permanent;</span><br></pre></td></tr></table></figure>
<p><strong>这比return指令效率低，因为它需要处理NGINX正则表达式，虽然是一个简单的（符号[^]，它匹配完整的原始URL）。</strong><br>
对应的return指令对于读者来说也更容易解释：return 301更清楚地指示NGINX返回代码301而不是rewrite …permanent 。</p>
<h3><span id="添加和删除www前缀"> 添加和删除www前缀</span></h3>
<p>如下示例添加和删除www前缀：</p>
<p>添加’www’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name domain.com;</span><br><span class="line">    return 301 $scheme://www.domain.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>删除’www’</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"> listen 80;</span><br><span class="line"> listen 443 ssl;</span><br><span class="line"> server_name www.domain.com;</span><br><span class="line"> return 301 $scheme://domain.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，<strong>return 效率更高于rewrite</strong>，如下。 重写需要解释正则表达式 – ^（。*）$ – 并创建一个自定义变量（$ 1），实际上等价于内置的 $request_uri 变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># NOT RECOMMENDED</span><br><span class="line">rewrite ^(.*)$ $scheme://www.domain.com$1 permanent;</span><br></pre></td></tr></table></figure>
<h3><span id="重定向所有的流量到正常的域名"> 重定向所有的流量到正常的域名</span></h3>
<p>这是一种特殊情况，当请求网址与任何服务器和位置块不匹配时，可能是因为域名拼写错误，将入站流量重定向到网站的主页。 它的工作原理是将default_server参数与listen指令组合，将下划线 _ 作为server_name指令的参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80 default_server;</span><br><span class="line">    listen 443 ssl default_server;</span><br><span class="line">    server_name _;</span><br><span class="line">    return 301 $scheme://www.domain.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用下划线作为server_name的参数，以避免无意中匹配真实的域名 – 可以安全地假设任何站点都不会有下划线作为其域名。 但是，与配置中的任何其他服务器块不匹配的请求都在这里，而且监听的default_server参数告诉NGINX为它们使用此块。 通过从重写的URL中省略$ request_uri变量，我们将所有请求重定向到主页，这是一个好主意，因为具有错误域名的请求尤其可能使用网站上不存在的URI。</p>
<h2><span id="示例强制所有请求使用-ssltls"> 示例：强制所有请求使用 SSL/TLS</span></h2>
<p>此server 块强制所有访问者对您的网站使用安全（SSL / TLS）连接。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.domain.com;</span><br><span class="line">    return 301 https://www.domain.com$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一些关于NGINX重写规则的其他博客使用if测试和rewrite指令来处理这个用例，像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># NOT RECOMMENDED</span><br><span class="line">if ($scheme != &quot;https&quot;) &#123;</span><br><span class="line">    rewrite ^ https://www.mydomain.com$uri permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是此方法需要额外的处理，因为NGINX必须同时判断if条件并处理rewrite指令中的正则表达式。</p>
<h2><span id="示例-为wordpress网站启用漂亮的固定链接"> 示例 – 为WordPress网站启用漂亮的固定链接</span></h2>
<p>NGINX和NGINX Plus是使用WordPress的网站非常受欢迎的应用交付平台。 下面的try_files指令告诉NGINX检查文件uri，然后是目录uri/的存在。 如果文件或目录不存在，NGINX将返回到/index.php的重定向并传递query-string参数，这些参数由$args参数捕获。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    try_files $uri $uri/ /index.php?$args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="示例-丢弃不受支持的文件扩展名的请求"> 示例 – 丢弃不受支持的文件扩展名的请求</span></h2>
<p>由于种种原因，您的网站可能会收到以与您未运行的应用程序服务器相对应的文件扩展名结尾的请求网址。 在本示例中，从Engine Yard博客，应用程序服务器是Ruby on Rails，因此无法处理由其他应用程序服务器（活动服务器页面，PHP，CGI等）处理的文件类型的请求，并且需要拒绝它们。 在将动态生成的资源的任何请求传递给应用程序的server 块中，此位置指令在非Rails文件类型的请求到达Rails队列之前丢弃该请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.(aspx|php|jsp|cgi)$ &#123;</span><br><span class="line">    return 410;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>严格地说，响应代码410（Gone）意在用于在所请求的资源在该URL处可用但不再是可用的情况，并且服务器不知道其当前位置（如果有的话）。 它相对于响应代码404的优点是它明确地指示资源永久不可用，因此客户端不会再次发送请求。</p>
<p>您可能希望通过返回响应代码403（禁止）和诸如“服务器仅处理Ruby请求”这样的解释作为文本字符串，为客户端提供更准确的失败原因指示。 作为替代，deny all伪指令返回403，不作解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ~ \.(aspx|php|jsp|cgi)$ &#123;</span><br><span class="line">    deny all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码403隐式地确认所请求的资源存在，因此如果想要通过向客户端提供尽可能少的信息来实现“通过模糊的安全性”，则代码404可能是更好的选择。 缺点是客户端可能会反复重试请求，因为404不指示失败是临时还是永久。</p>
<h2><span id="示例-配置自定义重新路由"> 示例 – 配置自定义重新路由</span></h2>
<p>在本示例中，您有一个资源，作为一组URL的控制器。 您的用户可以为资源使用更易读的名称，并重写（不重定向）它由控制器在listing.html处理。</p>
<p><code>rewrite ^/listings/(.*)$ /listing.html?listing=$1 last;</code></p>
<p>作为示例，用户友好的URL <a href="http://mysite.com/listings/123" target="_blank" rel="noopener">http://mysite.com/listings/123</a> 被重写为由 listing.html 控制器处理的URL， <a href="http://mysite.com/listing.html?listing=123" target="_blank" rel="noopener">http://mysite.com/listing.html?listing=123</a> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">翻译自：https://www.nginx.com/blog/creating-nginx-rewrite-rules/</span><br></pre></td></tr></table></figure>
</div><script type="text/javascript" src="/js/share.js?v=0.0.2" async></script><a class="article-share-link" data-url="yunke.science/2018/04/26/nginx-rewrite/" data-id="cjnk3ccvc003g6gvhi7rybf4x" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABwUlEQVR42u3aQY6DMAwFUO5/aUaa1Uio9NsOaTV6WaICjy6+YsfHEa/zd12v/F359VfPXLZwcXHH3PN2XR99/5rrvclvEgMuLu5+7n14vQqyVb9MDLi4uN/JXbtxwcXF/R/cSTDlAYeLi/s93KT4SUqaJAQ31Wq4uLgD7mQ7sjbsHunv4uLiFrlna1VByTFM9F5cXNwt3Hz7Mmma5OkU3YWLi7uFmyOqZUnvOLbwLlxc3Ae41a1J8svJCNebcMTFxd3CXXWAeh9Jb14f90BwcXH3cPPtS2+7Uy2KotzFxcXdyM0HI5K7Vg1jRa1SXFzcpdxewzQ/NK0WReVpEVxc3Me4k3iqbm56h7K4uLg7uXkM9aInL5CS5+Pi4u7h5s3KZDBr3v7oHdbi4uLu4VYLnt6YRR6aR3Xh4uI+wM1xvYDLY66Qu7i4uI9xq+VQ3kKtDl7g4uJ+insWV/XIJN/6RM/HxcXdwp0UP5MhjN4RLC4u7k5uL7x68dT7bFxc3E9xVwVNcqX62YWJD1xc3I9y563PZMwCFxf3+7n3D80/aVQ+4eLibuROhi97DdbesQouLu4e7rxhOv/U/I/DxcV9mPsDIkafZvTpNJUAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/nginx/">nginx</a></div><div class="post-nav"><a class="pre" href="/2018/04/28/nginx-process/">Nginx 指令的执行顺序</a><a class="next" href="/2018/04/25/meiwen02/">对于大多数普通人而言，情商比智商更重要？</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.2"><script src="/js/gitment.browser.js?v=0.0.2"></script><script>var gitment = new Gitment({
  owner: 'young-0',
  repo: 'young-0.github.io',
  oauth: {
    client_id: '967eeda5599f16063a0a',
    client_secret: '0c5aaeec2649210043608d7a09c7d19f0795f3f9',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="yunke.science"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kubernetes/">Kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/elk/">elk</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/fiction/">fiction</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/monitor/">monitor</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/美文/">美文</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/monitor/" style="font-size: 15px;">monitor</a> <a href="/tags/Kubernetes/" style="font-size: 15px;">Kubernetes</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/openresty/" style="font-size: 15px;">openresty</a> <a href="/tags/LuaRocks/" style="font-size: 15px;">LuaRocks</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/fiction/" style="font-size: 15px;">fiction</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/traefik/" style="font-size: 15px;">traefik</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/elk/" style="font-size: 15px;">elk</a> <a href="/tags/crond/" style="font-size: 15px;">crond</a> <a href="/tags/alpine/" style="font-size: 15px;">alpine</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/kcptun/" style="font-size: 15px;">kcptun</a> <a href="/tags/zabbix/" style="font-size: 15px;">zabbix</a> <a href="/tags/美文/" style="font-size: 15px;">美文</a> <a href="/tags/情商/" style="font-size: 15px;">情商</a> <a href="/tags/智商/" style="font-size: 15px;">智商</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/10/22/expose-pod-info/">k8s通过文件将Pod信息暴露给容器的方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/29/weave-net/">weave-net</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/k8s-1-11-3-etcd/">Kubernetes 1.11.3 使用kubeadm创建高可用的ETCD群集</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/27/k8s-1-11-install/">Kubernetes 1.11.3 安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/19/cka-faq/">CKA常见问题解答</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/28/redis-security/">redis 安全</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/27/http2-server-push/">使用NGINX 1.13.9引入HTTP2服务器推送</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/10/kubectl-overview/">kubectl概述</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/07/kuberouter-guide/">Kube-router 用户指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/18/k8sNetworkPolicy/">kubernetes 网络策略简单配置</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.21andy.com/manual/advanced-bash-scripting-guide/" title="高级Bash脚本编程指南" target="_blank">高级Bash脚本编程指南</a><ul></ul><a href="http://www.colasoft.com.cn/training/document.php" title="网络分析技术学习资料" target="_blank">网络分析技术学习资料</a><ul></ul><a href="https://k8smeetup.github.io/docs/home/" title="Kubernetes文档" target="_blank">Kubernetes文档</a><ul></ul><a href="https://www.bilibili.com/video/av21179285" title="TCPIP协议详解" target="_blank">TCPIP协议详解</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">天青色等烟雨.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.2" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.2" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zIndex="-2" count="50" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.2"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.2"></script></div></body></html>