<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Kubernetes HA 1.9 高可用集群kubeadm部署 | 天青色等烟雨  而我在等你</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.2"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-87247047-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kubernetes HA 1.9 高可用集群kubeadm部署</h1><a id="logo" href="/.">天青色等烟雨  而我在等你</a><p class="description">文不在多、有换则新、人不在挤、有来就行</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kubernetes HA 1.9 高可用集群kubeadm部署</h1><div class="post-meta">Mar 28, 2018<span> | </span><span class="category"><a href="/categories/Kubernetes/">Kubernetes</a></span></div><div class="post-content"><blockquote>
<p>Kubeadm是为提供kubeadm init 和 kubeadm join而创建的工具，它是创建Kubernetes集群的最佳实践“快速路径”。<br>
Kubeadm执行必要的操作以启动并运行最小的可用群集。 按照设计，它只关心引导，而不关心配置机器。 同样，安装各种不错的插件，如Kubernetes Dashboard，监控解决方案和云特定的插件，都不在范围之内。<br>
相反，我们希望在kubeadm的基础上构建更高级别和更多定制的工具，理想情况下，使用kubeadm作为所有部署的基础，可以更轻松地创建一致的集群。</p>
</blockquote>
<p><ul class="markdownIt-TOC">
<li><a href="#k8s-19-%E7%AE%80%E4%BB%8B">k8s 1.9 简介</a></li>
<li><a href="#kubernetes-%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84">Kubernetes 核心架构</a></li>
<li><a href="#%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83">部署环境：</a></li>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96">初始化</a>
<ul>
<li><a href="#%E8%AE%BE%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D">设置主机名</a></li>
<li><a href="#%E5%81%9C%E6%AD%A2%E9%98%B2%E7%81%AB%E5%A2%99">停止防火墙</a></li>
<li><a href="#%E5%85%B3%E9%97%ADswap">关闭Swap</a></li>
<li><a href="#selinux">Selinux</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE-dns">配置 dns</a></li>
<li><a href="#%E4%BF%AE%E6%94%B9%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0">修改内核参数</a></li>
</ul>
</li>
<li><a href="#%E9%85%8D%E7%BD%AEkeepalived">配置keepalived</a></li>
<li><a href="#etcd-https-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2">Etcd https 集群部署</a>
<ul>
<li><a href="#etcd-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">etcd 环境准备</a></li>
<li><a href="#etcd-https-%E8%AF%81%E4%B9%A6%E5%88%9B%E5%BB%BA">Etcd https 证书创建</a>
<ul>
<li><a href="#%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85">软件安装</a></li>
<li><a href="#%E7%94%9F%E6%88%90etcd%E7%9A%84tls-%E7%A7%98%E9%92%A5%E5%92%8C%E8%AF%81%E4%B9%A6">生成ETCD的TLS 秘钥和证书</a></li>
</ul>
</li>
<li><a href="#%E4%B8%8B%E8%BD%BD%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6">下载二进制安装文件</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA-etcd-%E7%9A%84-systemd-unit-%E6%96%87%E4%BB%B6">创建 etcd 的 systemd unit 文件</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8-etcd-%E6%9C%8D%E5%8A%A1">启动 etcd 服务</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81%E6%9C%8D%E5%8A%A1">验证服务</a></li>
</ul>
</li>
<li><a href="#k8s-%E5%AE%89%E8%A3%85">k8s 安装</a>
<ul>
<li><a href="#%E6%8F%90%E5%8F%96k8s-rpm-%E5%8C%85">提取k8s rpm 包</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8k8s">启动k8s</a></li>
<li><a href="#%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F">下载镜像</a></li>
</ul>
</li>
<li><a href="#kubeadm-init-%E5%88%9D%E5%A7%8B%E5%8C%96">Kubeadm Init 初始化</a></li>
<li><a href="#%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6-podnetwork">安装网络组件 podnetwork</a></li>
<li><a href="#%E9%83%A8%E7%BD%B2%E5%85%B6%E4%BB%96master-%E8%8A%82%E7%82%B9">部署其他Master 节点</a></li>
<li><a href="#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1">部署服务</a></li>
<li><a href="#%E9%AA%8C%E8%AF%81master-apiserver-%E9%AB%98%E5%8F%AF%E7%94%A8">验证master apiserver 高可用</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-kube-router-ipvs-%E6%9B%BF%E4%BB%A3-kube-proxy">使用 kube-router IPVS 替代 kube-proxy</a>
<ul>
<li><a href="#%E9%AA%8C%E8%AF%81-lvs-%E6%98%AF%E5%90%A6%E7%94%9F%E6%95%88">验证 lvs 是否生效</a></li>
</ul>
</li>
<li><a href="#%E6%B7%BB%E5%8A%A0-workload-%E8%8A%82%E7%82%B9">添加 workload 节点</a></li>
<li><a href="#kubernetes-dashboard-%E5%AE%89%E8%A3%85">kubernetes dashboard 安装</a>
<ul>
<li><a href="#kubernetes-dashboard-%E4%BB%8B%E7%BB%8D">kubernetes dashboard 介绍</a>
<ul>
<li><a href="#%E6%9C%80%E5%B0%8F%E6%9D%83%E9%99%90%E5%8E%9F%E5%88%99">最小权限原则</a></li>
<li><a href="#%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F">认证方式</a>
<ul>
<li><a href="#authorization-header-%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D">Authorization header 认证方式介绍</a></li>
</ul>
</li>
<li><a href="#kubernetes-dashboard-%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F">kubernetes dashboard 安装方式</a></li>
</ul>
</li>
<li><a href="#kubernetes-dashboard-%E9%83%A8%E7%BD%B2">kubernetes dashboard 部署</a></li>
</ul>
</li>
<li><a href="#%E7%9B%91%E6%8E%A7%E6%8F%92%E4%BB%B6-heapster-%E5%AE%89%E8%A3%85">监控插件 heapster 安装</a>
<ul>
<li><a href="#%E5%9C%A8-kubernetes-%E4%B8%AD%E9%83%A8%E7%BD%B2heapster">在 Kubernetes 中部署heapster</a></li>
<li><a href="#%E7%8B%AC%E7%AB%8B%E9%83%A8%E7%BD%B2-heapster">独立部署 heapster</a></li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8tr%C3%A6fik%E4%BD%9C%E4%B8%BAkubernetes%E9%9B%86%E7%BE%A4%E7%9A%84ingress%E6%8E%A7%E5%88%B6%E5%99%A8">使用Træfik作为Kubernetes集群的Ingress控制器</a>
<ul>
<li><a href="#rbac-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E9%85%8D%E7%BD%AE">RBAC 访问控制配置</a></li>
<li><a href="#daemonset%E9%83%A8%E7%BD%B2tr%C3%A6fik">DaemonSet部署Træfik</a></li>
<li><a href="#%E5%90%91%E7%BE%A4%E9%9B%86%E6%8F%90%E4%BA%A4-%E4%B8%80%E4%B8%AA-ingress">向群集提交 一个 ingress</a></li>
<li><a href="#%E6%B7%BB%E5%8A%A0%E8%AE%A4%E8%AF%81">添加认证</a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
</p>
<h2><span id="k8s-19-简介"> k8s 1.9 简介</span></h2>
<ul>
<li>kubernetes1.9版本发布2017年12月15日，每三个月一个迭代， Workloads API成为稳定版本，这消除了很多潜在用户对于该功能稳定性的担忧。还有一个重大更新，就是测试支持了Windows了，这打开了在kubernetes中运行Windows工作负载的大门。</li>
<li>CoreDNS alpha可以使用标准工具来安装CoreDNS</li>
<li>kube-proxy的IPVS模式进入beta版，为大型集群提供更好的可扩展性和性能。</li>
<li>kube-router的网络插件支持，更方便进行路由控制，发布，和安全策略管理</li>
</ul>
<h2><span id="kubernetes-核心架构"> Kubernetes 核心架构</span></h2>
<p>k8s 高可用2个核心 <mark>apiserver master</mark> and <mark>etcd</mark></p>
<p><mark>apiserver master</mark>：（需高可用）集群核心，集群API接口、集群各个组件通信的中枢；集群安全控制；</p>
<p><mark>etcd</mark> ：（需高可用）集群的数据中心，用于存放集群的配置以及状态信息，非常重要，如果数据丢失那么集群将无法恢复；因此高可用集群部署首先就是etcd是高可用集群；</p>
<p>kube-scheduler：调度器 （内部自选举）集群Pod的调度中心；默认kubeadm安装情况下–leader-elect参数已经设置为true，保证master集群中只有一个kube-scheduler处于活跃状态；</p>
<p>kube-controller-manager： 控制器 （内部自选举）集群状态管理器，当集群状态与期望不同时，kcm会努力让集群恢复期望状态，比如：当一个pod死掉，kcm会努力新建一个pod来恢复对应replicas set期望的状态；默认kubeadm安装情况下–leader-elect参数已经设置为true，保证master集群中只有一个kube-controller-manager处于活跃状态；</p>
<p>kubelet: agent node注册apiserver</p>
<p>kube-proxy: 每个node上一个，负责service vip到endpoint pod的流量转发，老版本主要通过设置iptables规则实现，新版1.9基于kube-proxy-lvs 实现</p>
<p>集群HA方案，我们力求简单，使用keepalive 监听一个vip来实现，（当节点不可以后，会有vip漂移的切换时长，取决于我们设置timeout切换时长，测试会有10s空档期，如果对高可用更高要求 可以用lvs或者nginx做 4层lb负载 更佳完美，我们力求简单够用，可接受10s的api不可用）</p>
<h2><span id="部署环境"> 部署环境：</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker Server Version: 1.12.6</span><br><span class="line">CentOS Linux  3.10.0-327.el7.x86_64</span><br><span class="line">kubeadm version GitVersion:&quot;v1.9.6&quot;</span><br><span class="line">Kubernetes version v1.9.6</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>docker01</td>
<td>192.168.0.65</td>
</tr>
<tr>
<td>docker02</td>
<td>192.168.0.67</td>
</tr>
<tr>
<td>docker03</td>
<td>192.168.0.31</td>
</tr>
</tbody>
</table>
<h2><span id="初始化"> 初始化</span></h2>
<h3><span id="设置主机名"> 设置主机名</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl  set-hostname docker01</span><br><span class="line">hostnamectl  set-hostname docker02</span><br><span class="line">hostnamectl  set-hostname docker03</span><br></pre></td></tr></table></figure>
<h3><span id="停止防火墙"> 停止防火墙</span></h3>
<p>systemctl disable firewalld &amp;&amp; systemctl stop firewalld &amp;&amp; systemctl status firewalld</p>
<h3><span id="关闭swap"> 关闭Swap</span></h3>
<blockquote>
<p>swapoff -a<br>
sed  ‘s/.<em>swap.</em>/#&amp;/’ /etc/fstab</p>
</blockquote>
<h3><span id="selinux"> Selinux</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ -f /etc/selinux/config ] &amp;&amp; sed -i &apos;s/^SELINUX=.*/SELINUX=disabled/g&apos; /etc/selinux/config</span><br><span class="line">[ -f /etc/sysconfig/selinux ] &amp;&amp; sed -i &apos;s/^SELINUX=.*/SELINUX=disabled/g&apos; /etc/sysconfig/selinux</span><br><span class="line">[ -x /usr/sbin/setenforce ] &amp;&amp; /usr/sbin/setenforce 0</span><br></pre></td></tr></table></figure>
<h3><span id="配置-dns"> 配置 dns</span></h3>
<blockquote>
<p>echo nameserver 114.114.114.114&gt;&gt;/etc/resolv.conf</p>
</blockquote>
<h3><span id="修改内核参数"> 修改内核参数</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl -p /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/net/bridge/bridge-nf-call-iptables</span><br><span class="line">echo 1 &gt; /proc/sys/net/bridge/bridge-nf-call-ip6tables</span><br></pre></td></tr></table></figure>
<h2><span id="配置keepalived"> 配置keepalived</span></h2>
<ul>
<li>VIP Master 通过控制VIP 来HA高可用</li>
<li>到目前为止,三个master节点 相互独立运行,互不干扰. kube-apiserver作为核心入口, 可以使用keepalived 实现高可用,</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br></pre></td></tr></table></figure>
<p>配置keepalived.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/keepalived/keepalived.conf  &lt;&lt;EOL</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script CheckK8sMaster &#123;</span><br><span class="line">    script &quot;curl -k https://192.168.0.32:6443&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    timeout 9</span><br><span class="line">    fall 2</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    priority 100</span><br><span class="line">    interface em1</span><br><span class="line">    virtual_router_id 61</span><br><span class="line">    advert_int 1</span><br><span class="line">    # 多播源地址，默认为绑定的网卡IP</span><br><span class="line">    # mcast_src_ip 10.129.6.211</span><br><span class="line">    # 非抢占模式</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass ndikfXSx6uKpgU8D9NV7</span><br><span class="line">    &#125;</span><br><span class="line">    # 单播方式，其他节点的地址</span><br><span class="line">    # unicast_peer &#123;</span><br><span class="line">    #     #注释掉本地IP</span><br><span class="line">    #     #10.129.6.211</span><br><span class="line">    #     10.129.6.212</span><br><span class="line">    #     10.129.6.213</span><br><span class="line">    # &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.0.32/24</span><br><span class="line">    &#125;</span><br><span class="line">    # track_script &#123;</span><br><span class="line">    #     CheckK8sMaster</span><br><span class="line">    # &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">EOL</span><br></pre></td></tr></table></figure>
<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable keepalived &amp;&amp; systemctl restart keepalived</span><br><span class="line"></span><br><span class="line">错误： Unable to load ipset library - libipset.so.3: cannot open shared object file: No such file or directory</span><br><span class="line">安装软件包： yum install libnl3-devel ipset-devel -y</span><br></pre></td></tr></table></figure>
<p>配置其他主机，修改state 为BACKUP 和 priority 优先级<br>
priority 越大，优先级越高</p>
<p>在 master 上停止 keepalived.service ，测试 VIP 是否切换到其他主机。</p>
<h2><span id="etcd-https-集群部署"> Etcd https 集群部署</span></h2>
<h3><span id="etcd-环境准备"> etcd 环境准备</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#机器名称</span><br><span class="line">docker01：192.168.0.65</span><br><span class="line">docker02：192.168.0.67</span><br><span class="line">docker03：192.168.0.31</span><br><span class="line"></span><br><span class="line">#部署环境变量. 每台主机上都要添加，添加到 /etc/profile</span><br><span class="line">export NODE_NAME=docker01 #当前部署的机器名称(随便定义，只要能区分不同机器即可)</span><br><span class="line">export NODE_IP=192.168.0.65 # 当前部署的机器 IP</span><br><span class="line">export NODE_IPS=&quot;192.168.0.65 192.168.0.67 192.168.0.31&quot; # etcd 集群所有机器 IP</span><br><span class="line"># etcd 集群间通信的IP和端口</span><br><span class="line">export ETCD_NODES=docker01=https://192.168.0.65:2380,docker02=https://192.168.0.67:2380,docker03=https://192.168.0.31:2380</span><br></pre></td></tr></table></figure>
<h3><span id="etcd-https-证书创建"> Etcd https 证书创建</span></h3>
<h4><span id="软件安装"> 软件安装</span></h4>
<ul>
<li>安装cfssl， CloudFlare 的 PKI 工具集 cfssl 来生成 Certificate Authority (CA) 证书和秘钥文件</li>
<li>如果不希望将cfssl工具安装到部署主机上，可以在其他的主机上进行该步骤，生成以后将证书拷贝到部署etcd的主机上即可。本教程就是采取这种方法，在一台测试机上执行下面操作。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">chmod +x cfssljson_linux-amd64</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span><br></pre></td></tr></table></figure>
<h4><span id="生成etcd的tls-秘钥和证书"> 生成ETCD的TLS 秘钥和证书</span></h4>
<ul>
<li>为了保证通信安全，客户端(如 etcdctl) 与 etcd 集群、etcd 集群之间的通信需要使用 TLS 加密，本节创建 etcd TLS 加密所需的证书和私钥。</li>
</ul>
<p>创建 CA 配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">&quot;signing&quot;: &#123;</span><br><span class="line">&quot;default&quot;: &#123;</span><br><span class="line">  &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;profiles&quot;: &#123;</span><br><span class="line">  &quot;kubernetes&quot;: &#123;</span><br><span class="line">    &quot;usages&quot;: [</span><br><span class="line">        &quot;signing&quot;,</span><br><span class="line">        &quot;key encipherment&quot;,</span><br><span class="line">        &quot;server auth&quot;,</span><br><span class="line">        &quot;client auth&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><mark>ca-config.json</mark>：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；<br>
<mark>signing</mark>：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；<br>
<mark>server auth</mark>：表示 client 可以用该 CA 对 server 提供的证书进行验证；<br>
<mark>client auth</mark>：表示 server 可以用该 CA 对 client 提供的证书进行验证；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">&quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">&quot;key&quot;: &#123;</span><br><span class="line">&quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">&quot;size&quot;: 2048</span><br><span class="line">&#125;,</span><br><span class="line">&quot;names&quot;: [</span><br><span class="line">&#123;</span><br><span class="line">  &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">  &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">  &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">  &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">  &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>“CN”：Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</p>
</li>
<li>
<p>“O”：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</p>
</li>
<li>
<p><mark>生成 CA 证书和私钥</mark>：<br>
<strong># cfssl gencert -initca ca-csr.json | cfssljson -bare ca</strong></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ls ca*  </span><br><span class="line">-rw-r--r-- 1 root root  232 Mar 24 18:31 ca-config.json</span><br><span class="line">-rw-r--r-- 1 root root 1001 Mar 24 18:32 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root  162 Mar 24 18:31 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Mar 24 18:32 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1359 Mar 24 18:32 ca.pem</span><br></pre></td></tr></table></figure>
<ul>
<li><mark>创建 etcd 证书签名请求：</mark></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;192.168.0.65&quot;,</span><br><span class="line">    &quot;192.168.0.67&quot;,</span><br><span class="line">    &quot;192.168.0.31&quot;,</span><br><span class="line">    &quot;192.168.0.32&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>hosts 字段指定授权使用该证书的 etcd 节点 IP；</li>
<li>每个节点IP 都要在里面 或者 每个机器申请一个对应IP的证书</li>
</ul>
<p>生成 etcd 证书和私钥：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -ca=ca.pem \</span><br><span class="line">  -ca-key=ca-key.pem \</span><br><span class="line">  -config=ca-config.json \</span><br><span class="line">  -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"></span><br><span class="line"># ls -lt etcd*</span><br><span class="line">-rw-r--r-- 1 root root 1070 Mar 24 18:38 etcd.csr</span><br><span class="line">-rw-r--r-- 1 root root  316 Mar 24 18:37 etcd-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Mar 24 18:38 etcd-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1444 Mar 24 18:38 etcd.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir -p /etc/etcd/ssl</span><br><span class="line">cp etcd.pem etcd-key.pem  ca.pem /etc/etcd/ssl/</span><br><span class="line"></span><br><span class="line">打包并传输到其他主机上</span><br><span class="line">tar zcvf  etcd_ssl.tar.gz /etc/etcd/ssl/</span><br><span class="line"></span><br><span class="line">#其他主机上解压</span><br><span class="line">rm -rf /etc/etcd/ssl/*</span><br><span class="line">tar xf etcd_ssl.tar.gz -C /</span><br><span class="line">ls /etc/etcd/ssl/</span><br></pre></td></tr></table></figure>
<h3><span id="下载二进制安装文件"> 下载二进制安装文件</span></h3>
<p>到 <a href="https://github.com/coreos/etcd/releases" target="_blank" rel="noopener">https://github.com/coreos/etcd/releases</a> 页面下载最新版本的二进制文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/coreos/etcd/releases/download/v3.3.2/etcd-v3.3.2-linux-amd64.tar.gz</span><br><span class="line">tar xf etcd-v3.3.2-linux-amd64.tar.gz</span><br><span class="line">mv etcd-v3.3.2-linux-amd64/etcd* /usr/local/bin/</span><br></pre></td></tr></table></figure>
<h3><span id="创建-etcd-的-systemd-unit-文件"> 创建 etcd 的 systemd unit 文件</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/etcd</span><br><span class="line"></span><br><span class="line">创建文件之前，一定要先设置环境变量。并加载环境变量</span><br><span class="line"></span><br><span class="line">cat &gt; etcd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">ExecStart=/usr/local/bin/etcd \\</span><br><span class="line">  --name=$&#123;NODE_NAME&#125; \\</span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \\</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \\</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class="line">  --trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span><br><span class="line">  --initial-advertise-peer-urls=https://$&#123;NODE_IP&#125;:2380 \\</span><br><span class="line">  --listen-peer-urls=https://$&#123;NODE_IP&#125;:2380 \\</span><br><span class="line">  --listen-client-urls=https://$&#123;NODE_IP&#125;:2379,http://127.0.0.1:2379 \\</span><br><span class="line">  --advertise-client-urls=https://$&#123;NODE_IP&#125;:2379 \\</span><br><span class="line">  --initial-cluster-token=etcd-cluster-0 \\</span><br><span class="line">  --initial-cluster=$&#123;ETCD_NODES&#125; \\</span><br><span class="line">  --initial-cluster-state=new \\</span><br><span class="line">  --data-dir=/var/lib/etcd</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mv etcd.service /etc/systemd/system/</span><br></pre></td></tr></table></figure>
<ul>
<li>指定 etcd 的工作目录和数据目录为 /var/lib/etcd，需在启动服务前创建这个目录；</li>
<li>为了保证通信安全，需要指定 etcd 的公私钥(cert-file和key-file)、Peers 通信的公私钥和 CA 证书(peer-cert-file、peer-key-file、peer-trusted-ca-file)、客户端的CA证书（trusted-ca-file）；</li>
<li>–initial-cluster-state 值为 new 时，–name 的参数值必须位于 –initial-cluster 列表中；</li>
</ul>
<h3><span id="启动-etcd-服务"> 启动 etcd 服务</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable etcd</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure>
<h3><span id="验证服务"> 验证服务</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">  --endpoints=https://$&#123;NODE_IP&#125;:2379  \</span><br><span class="line">  --ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  cluster-health</span><br></pre></td></tr></table></figure>
<p>结果验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">member 5610ea0b10a20992 is healthy: got healthy result from https://192.168.0.67:2379</span><br><span class="line">member 6f78cb98381e75db is healthy: got healthy result from https://192.168.0.65:2379</span><br><span class="line">member cef55d543e12e2d1 is healthy: got healthy result from https://192.168.0.31:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>
<p>如果失败，需要删除目录，重新配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop etcd</span><br><span class="line">rm -Rf /var/lib/etcd</span><br><span class="line">rm -Rf /var/lib/etcd-cluster</span><br><span class="line">mkdir -p /var/lib/etcd</span><br><span class="line">systemctl start etcd</span><br></pre></td></tr></table></figure>
<h2><span id="k8s-安装"> k8s 安装</span></h2>
<h3><span id="提取k8s-rpm-包"> 提取k8s rpm 包</span></h3>
<ul>
<li>离线导入下rpm 仓库</li>
<li>安装官方YUM 仓库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://yum.kubernetes.io/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg</span><br><span class="line">       https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">离线下载rpm包</span><br><span class="line">mkdir k8srpm &amp;&amp; cd k8srpm</span><br><span class="line">yum install -y yum-utils</span><br><span class="line">yumdownloader kubelet kubeadm kubectl kubernetes-cni</span><br><span class="line"></span><br><span class="line"># du -sh *</span><br><span class="line">8.9M    c9a30a9b3cd4f8b83a3ffcbfe5a23b32c0c78ec90a8e67505ba4ae31ed1d7a69-kubectl-1.9.6-0.x86_64.rpm</span><br><span class="line">17M     f56f3294d633ecfa7f2aac506f7267c00547d4c529b134bc4698a563402897c3-kubeadm-1.9.6-0.x86_64.rpm</span><br><span class="line">8.6M    fe33057ffe95bfae65e2f269e1b05e99308853176e24a4d027bc082b471a07c0-kubernetes-cni-0.6.0-0.x86_64.rpm</span><br><span class="line">17M     fff4e7133c41ce6aaca95adb598f47967d180c4c5e8e6c67d8bfe58345bfde27-kubelet-1.9.6-0.x86_64.rpm</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">打包发送到三台主机，yum离线安装</span><br><span class="line">yum install  k8srpm/*.rpm -y</span><br></pre></td></tr></table></figure>
<h3><span id="启动k8s"> 启动k8s</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">修改KUBELET_CGROUP_ARGS=--cgroup-driver 与docker Cgroup Driver 相同</span><br><span class="line">cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf | grep cgroup-driver=</span><br><span class="line">docker info | grep &apos;Cgroup Driver&apos;</span><br><span class="line">比较以上两个的值。修改 /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">#Environment=&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=systemd&quot;</span><br><span class="line">Environment=&quot;KUBELET_CGROUP_ARGS=--cgroup-driver=cgroupfs&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></table></figure>
<h3><span id="下载镜像"> 下载镜像</span></h3>
<blockquote>
<p>在其他主机上下载gcr.io镜像，上传到私有镜像仓库。<br>
以后就可以通过拉取私有镜像仓库中的镜像，使用tag 重命名即可。</p>
</blockquote>
<p>以下是 本文使用到的镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker pull gcr.io/google_containers/kube-apiserver-amd64:v1.9.6</span><br><span class="line">docker pull gcr.io/google_containers/kube-controller-manager-amd64:v1.9.6</span><br><span class="line">docker pull gcr.io/google_containers/kube-scheduler-amd64:v1.9.6</span><br><span class="line">docker pull gcr.io/google_containers/kube-proxy-amd64:v1.9.6</span><br><span class="line">docker pull gcr.io/google_containers/pause-amd64:3.0</span><br><span class="line">docker pull coredns/coredns:1.0.1</span><br><span class="line">docker pull cloudnativelabs/kube-router:latest</span><br><span class="line">docker pull cloudnativelabs/whats-my-ip:latest</span><br><span class="line">docker pull busybox:latest</span><br><span class="line">k8s.gcr.io/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">k8s.gcr.io/heapster-amd64:v1.4.2</span><br><span class="line">traefik:v1.5.4-alpine</span><br></pre></td></tr></table></figure>
<h2><span id="kubeadm-init-初始化"> Kubeadm Init 初始化</span></h2>
<blockquote>
<p>我们使用config 模板方式来初始化集群，便于我们指定etcd 集群<br>
private.domain 使我们的 测试镜像仓库 可以改成自己或者手动导入每个机器镜像</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; config.yaml </span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha1</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">etcd:</span><br><span class="line">  endpoints:</span><br><span class="line">  - https://192.168.0.31:2379</span><br><span class="line">  - https://192.168.0.65:2379</span><br><span class="line">  - https://192.168.0.67:2379</span><br><span class="line">  caFile: /etc/etcd/ssl/ca.pem </span><br><span class="line">  certFile: /etc/etcd/ssl/etcd.pem </span><br><span class="line">  keyFile: /etc/etcd/ssl/etcd-key.pem</span><br><span class="line">  dataDir: /var/lib/etcd</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: 10.42.0.0/16</span><br><span class="line">kubernetesVersion: 1.9.6</span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: &quot;192.168.0.32&quot;</span><br><span class="line">token: &quot;b99a00.a144ef80536d4344&quot;</span><br><span class="line">tokenTTL: &quot;0s&quot;</span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- docker01</span><br><span class="line">- docker02</span><br><span class="line">- docker03</span><br><span class="line">- 192.168.0.31</span><br><span class="line">- 192.168.0.32</span><br><span class="line">- 192.168.0.65</span><br><span class="line">- 192.168.0.67</span><br><span class="line">featureGates:</span><br><span class="line">  CoreDNS: true</span><br><span class="line"># imageRepository: &quot;devhub.beisencorp.com/google_containers&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>初始化集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config config.yaml</span><br></pre></td></tr></table></figure>
<p>执行结果（翻译后的操作）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">说明Kubernetes版本，启用认证[Node RBAC]，</span><br><span class="line">验证docker服务是否开机启动，启动kubelet服务。</span><br><span class="line">生成ca证书和密钥。 </span><br><span class="line">生成的apiserver证书和密钥。apiserver服务证书签署DNS名称。</span><br><span class="line">生成了apiserver-kubelet-client证书和密钥。</span><br><span class="line">生成sa密钥和公钥。</span><br><span class="line">生成的前置代理 ca 证书和密钥。</span><br><span class="line">生成了前端代理 client 证书和密钥。</span><br><span class="line">生成配置文件：&quot;admin.conf&quot;，&quot;kubelet.conf&quot;，&quot;controller-manager.conf&quot;，&quot;scheduler.conf&quot;</span><br><span class="line">生成 组件 kube-apiserver、kube-controller-manager、kube-scheduler三个组建 yaml文件，在/etc/kubernetes/manifests/。</span><br><span class="line">kubelet 启动以上三个组件，组件启动成功。(三个image必须可以下载或者已经下载成功)</span><br><span class="line">在“kube-system”名称空间中存储ConfigMap“kubeadm-config”中使用的配置。</span><br><span class="line">将标记节点docker01作为master，添加标签和taint点。为mater docker01 添加标签node-role.kubernetes.io/master=&quot;&quot;。</span><br><span class="line">输出token。</span><br><span class="line">配置的RBAC规则，允许节点引导token在节点上发布CSRs以获得长期证书凭证。允许csrapprover控制器自动地从一个节点引导令牌中批准csr。允许集群中所有节点客户端证书的证书循环。</span><br><span class="line">在“kube-public”名称空间中创建“cluster-info”ConfigMap。</span><br><span class="line">应用 CoreDNS 和 kube-proxy。</span><br><span class="line">Kubernetes master 初始化完成。</span><br><span class="line"></span><br><span class="line">以下配置集群，方便使用 kubectl 部署操作。</span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -fi /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">现在可以通过在每个节点上运行以下操作来连接任意数量的计算机。</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join --token b99a00.a144ef80536d4344 192.168.0.32:6443 --discovery-token-ca-cert-hash sha256:5a754d4f646da0519301a482534db6147debfbf718202e0d85155da933e46a21</span><br></pre></td></tr></table></figure>
<p>按照上面执行以下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -fi /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>
<p>获取状态信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 ~]# kubectl get node</span><br><span class="line">NAME       STATUS     ROLES     AGE       VERSION</span><br><span class="line">docker01   NotReady   master    12h       v1.9.6</span><br><span class="line">[root@docker01 ~]# kubectl get cs  </span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;  </span><br><span class="line">[root@docker01 ~]# kubectl get pod --all-namespaces -o wide</span><br><span class="line">NAMESPACE     NAME                               READY     STATUS    RESTARTS   AGE       IP             NODE</span><br><span class="line">kube-system   coredns-65dcdb4cf-x9qdm            0/1       Pending   0          2m        &lt;none&gt;         &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-docker01            1/1       Running   0          1m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-controller-manager-docker01   1/1       Running   0          1m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-proxy-d4frm                   1/1       Running   0          2m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-scheduler-docker01            1/1       Running   0          1m        192.168.0.65   docker01</span><br><span class="line"></span><br><span class="line">由于未安装网络模块，coredns 处于 Pending 状态，这是正常的。</span><br></pre></td></tr></table></figure>
<p>集群初始化如果遇到问题，可以使用下面的命令进行清理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure>
<h2><span id="安装网络组件-podnetwork"> 安装网络组件 podnetwork</span></h2>
<blockquote>
<p><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network</a><br>
安装网络插件以后，docker01 status变为Ready。coredns STATUS 变为 Running</p>
</blockquote>
<ul>
<li>kube-router提供pod网络和网络策略<br>
KUBECONFIG=/etc/kubernetes/admin.conf kubectl apply -f <a href="https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- 如果要使用 lvs 替代Iptables，执行以下操作。kube-router提供service prox,pod网络和网络策略    </span><br><span class="line">KUBECONFIG=/etc/kubernetes/admin.conf kubectl apply -f https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter-all-features.yaml</span><br><span class="line">&gt; 现在，因为kube-router也提供服务代理。 运行以下命令删除kube-proxy并清除它可能完成的任何iptables配置。</span><br><span class="line"></span><br><span class="line">KUBECONFIG=/etc/kubernetes/admin.conf kubectl -n kube-system delete ds kube-proxy  </span><br><span class="line">docker run --privileged --net=host gcr.io/google_containers/kube-proxy-amd64:v1.7.3 kube-proxy --cleanup-iptables</span><br></pre></td></tr></table></figure>
<p>再次查看状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod --all-namespaces -o wide</span><br><span class="line">NAMESPACE     NAME                               READY     STATUS    RESTARTS   AGE       IP             NODE</span><br><span class="line">kube-system   coredns-65dcdb4cf-x9qdm            1/1       Running   0          9m        10.42.0.2      docker01</span><br><span class="line">kube-system   kube-apiserver-docker01            1/1       Running   0          8m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-controller-manager-docker01   1/1       Running   0          8m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-proxy-d4frm                   1/1       Running   0          9m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-router-ck8vt                  1/1       Running   0          3m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-scheduler-docker01            1/1       Running   0          8m        192.168.0.65   docker01</span><br></pre></td></tr></table></figure>
<h2><span id="部署其他master-节点"> 部署其他Master 节点</span></h2>
<p>拷贝 pki证书到其他主机<br>
tar zcvf pki.tar.gz /etc/kubernetes/pki/<br>
打包pki.tar.gz传输到其他主机，解压 tar xf pki.tar.gz -C /</p>
<p>拷贝初始化配置config.yaml<br>
修改 /etc/systemd/system/kubelet.service.d/10-kubeadm.conf<br>
拉取 <a href="http://gcr.io" target="_blank" rel="noopener">gcr.io</a> 镜像</p>
<p>执行操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config config.yaml</span><br></pre></td></tr></table></figure>
<p>查看所有服务的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pod --all-namespaces -o wide</span><br><span class="line">NAMESPACE     NAME                               READY     STATUS    RESTARTS   AGE       IP             NODE</span><br><span class="line">kube-system   coredns-65dcdb4cf-5fwqh            1/1       Running   0          4m        10.42.1.2      docker03</span><br><span class="line">kube-system   kube-apiserver-docker01            1/1       Running   0          3m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-apiserver-docker02            1/1       Running   0          3m        192.168.0.67   docker02</span><br><span class="line">kube-system   kube-apiserver-docker03            1/1       Running   0          3m        192.168.0.31   docker03</span><br><span class="line">kube-system   kube-controller-manager-docker01   1/1       Running   0          3m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-controller-manager-docker02   1/1       Running   0          3m        192.168.0.67   docker02</span><br><span class="line">kube-system   kube-controller-manager-docker03   1/1       Running   0          3m        192.168.0.31   docker03</span><br><span class="line">kube-system   kube-proxy-4gwpv                   1/1       Running   0          3m        192.168.0.67   docker02</span><br><span class="line">kube-system   kube-proxy-4sjd6                   1/1       Running   0          4m        192.168.0.31   docker03</span><br><span class="line">kube-system   kube-proxy-rhf4p                   1/1       Running   0          4m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-router-8wk4r                  1/1       Running   0          1m        192.168.0.31   docker03</span><br><span class="line">kube-system   kube-router-qt6hk                  1/1       Running   0          1m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-router-r65f9                  1/1       Running   0          1m        192.168.0.67   docker02</span><br><span class="line">kube-system   kube-scheduler-docker01            1/1       Running   0          3m        192.168.0.65   docker01</span><br><span class="line">kube-system   kube-scheduler-docker02            1/1       Running   0          3m        192.168.0.67   docker02</span><br><span class="line">kube-system   kube-scheduler-docker03            1/1       Running   0          3m        192.168.0.31   docker03</span><br></pre></td></tr></table></figure>
<h2><span id="部署服务"> 部署服务</span></h2>
<p>默认情况下，为了保证master的安全，master是不会被调度到app的。你可以取消这个限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl taint nodes --all node-role.kubernetes.io/master-</span><br><span class="line">node &quot;docker01&quot; untainted</span><br><span class="line">node &quot;docker02&quot; untainted</span><br><span class="line">node &quot;docker03&quot; untainted</span><br></pre></td></tr></table></figure>
<p>部署三个副本</p>
<blockquote>
<p>cloudnativelabs/whats-my-ip 是一个每次请求，返回当前主机的主机名和IP的服务</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run myip --image=cloudnativelabs/whats-my-ip --replicas=3 --port=8080</span><br></pre></td></tr></table></figure>
<p>创建一个服务，类型为NodePort</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment myip --port=8080 --target-port=8080 --type=NodePort</span><br></pre></td></tr></table></figure>
<p>查看服务状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 k8srpm]# kubectl get pod -o wide</span><br><span class="line">NAME                    READY     STATUS    RESTARTS   AGE       IP          NODE</span><br><span class="line">myip-859c596bbf-228z2   1/1       Running   0          2m        10.42.1.3   docker03</span><br><span class="line">myip-859c596bbf-4jdvg   1/1       Running   0          2m        10.42.0.3   docker01</span><br><span class="line">myip-859c596bbf-vnt82   1/1       Running   0          2m        10.42.2.2   docker02</span><br><span class="line">[root@docker01 k8srpm]# kubectl get svc -o wide</span><br><span class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE       SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP          15m       &lt;none&gt;</span><br><span class="line">myip         NodePort    10.111.69.75   &lt;none&gt;        8080:31526/TCP   1m        run=myip</span><br></pre></td></tr></table></figure>
<p>请求服务：</p>
<blockquote>
<p>可以看到默认使用的是round-robin算法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 请求 service:port</span><br><span class="line">[root@docker01 ~]# curl 10.111.69.75:8080</span><br><span class="line">HOSTNAME:myip-859c596bbf-vnt82 IP:10.42.2.2</span><br><span class="line">[root@docker01 ~]# curl 10.111.69.75:8080</span><br><span class="line">HOSTNAME:myip-859c596bbf-4jdvg IP:10.42.0.3</span><br><span class="line">[root@docker01 ~]# curl 10.111.69.75:8080</span><br><span class="line">HOSTNAME:myip-859c596bbf-228z2 IP:10.42.1.3</span><br><span class="line"></span><br><span class="line"># 请求 nodeIP:NodePort</span><br><span class="line">[root@docker01 ~]# curl 192.168.0.65:31526</span><br><span class="line">HOSTNAME:myip-859c596bbf-vnt82 IP:10.42.2.2</span><br><span class="line">[root@docker01 ~]# curl 192.168.0.67:31526</span><br><span class="line">HOSTNAME:myip-859c596bbf-vnt82 IP:10.42.2.2</span><br><span class="line">[root@docker01 ~]# curl 192.168.0.31:31526</span><br><span class="line">HOSTNAME:myip-859c596bbf-vnt82 IP:10.42.2.2</span><br></pre></td></tr></table></figure>
<h2><span id="验证master-apiserver-高可用"> 验证master apiserver 高可用</span></h2>
<p>停止 docker01 主机 上的 keepalived 服务，<br>
观察当Master01主节点 keepalived 关闭后，备节点VIP状态  BACKUP  切换到 MASTER<br>
验证 apiserver 的高可用。</p>
<p>停止 docker01 主机，验证高可用.</p>
<h2><span id="使用-kube-router-ipvs-替代-kube-proxy"> 使用 kube-router IPVS 替代 kube-proxy</span></h2>
<p>删除当前的 kuberouter<br>
kubectl delete -f <a href="https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml</a></p>
<ul>
<li>如果要使用 lvs 替代Iptables，执行以下操作。kube-router提供service prox,pod网络和网络策略<br>
KUBECONFIG=/etc/kubernetes/admin.conf kubectl apply -f <a href="https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter-all-features.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter-all-features.yaml</a></li>
</ul>
<blockquote>
<p>现在，因为kube-router也提供服务代理。 运行以下命令删除kube-proxy并清除它可能完成的任何iptables配置。</p>
</blockquote>
<p>KUBECONFIG=/etc/kubernetes/admin.conf kubectl -n kube-system delete ds kube-proxy<br>
docker run --privileged --net=host <a href="http://gcr.io/google_containers/kube-proxy-amd64:v1.9.6" target="_blank" rel="noopener">gcr.io/google_containers/kube-proxy-amd64:v1.9.6</a> kube-proxy --cleanup</p>
<h3><span id="验证-lvs-是否生效"> 验证 lvs 是否生效</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@docker03 k8srpm]# kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP          33m</span><br><span class="line">myip         NodePort    10.111.69.75   &lt;none&gt;        8080:31526/TCP   19m</span><br><span class="line">[root@docker03 k8srpm]# ipvsadm        </span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  docker03:31526 rr</span><br><span class="line">  -&gt; 10.42.0.3:webcache           Masq    1      0          0         </span><br><span class="line">  -&gt; 10.42.1.3:webcache           Masq    1      0          0         </span><br><span class="line">  -&gt; 10.42.2.2:webcache           Masq    1      0          0         </span><br><span class="line">TCP  10.96.0.1:https rr persistent 10800</span><br><span class="line">  -&gt; 192.168.0.32:sun-sr-https    Masq    1      0          0         </span><br><span class="line">TCP  10.96.0.10:domain rr</span><br><span class="line">  -&gt; 10.42.1.2:domain             Masq    1      0          0         </span><br><span class="line">TCP  10.111.69.75:webcache rr</span><br><span class="line">  -&gt; 10.42.0.3:webcache           Masq    1      0          0         </span><br><span class="line">  -&gt; 10.42.1.3:webcache           Masq    1      0          0         </span><br><span class="line">  -&gt; 10.42.2.2:webcache           Masq    1      0          0         </span><br><span class="line">UDP  10.96.0.10:domain rr</span><br><span class="line">  -&gt; 10.42.1.2:domain             Masq    1      0          0</span><br></pre></td></tr></table></figure>
<h2><span id="添加-workload-节点"> 添加 workload 节点</span></h2>
<p>以上配置均为 master节点，下面添加  workload 节点<br>
执行初始化操作<br>
kubeadm join --token <token> <master-ip>:<master-port> --discovery-token-ca-cert-hash sha256:<hash><br>
语句即为master节点 初始化操作的最后一步：<br>
kubeadm join --token b99a00.a144ef80536d4344 192.168.0.32:6443 --discovery-token-ca-cert-hash sha256:5a754d4f646da0519301a482534db6147debfbf718202e0d85155da933e46a21</hash></master-port></master-ip></token></p>
<h2><span id="kubernetes-dashboard-安装"> kubernetes dashboard 安装</span></h2>
<blockquote>
<p>一旦Dashboard安装并可访问，我们就可以专注于为用户配置对群集资源的访问控制。 从版本1.7仪表板不再具有默认授予的完全管理权限。 所有权限都被撤销，只有授予的最小权限才能使Dashboard正常工作。<br>
重要提示：本说明仅针对使用Dashboard 1.7及以上版本的用户。 如果Dashboard只能由可信任的人员访问，所有人都可以使用完全管理权限授予管理员权限 。 请注意，其他应用程序不应直接访问仪表板，因为它可能导致特权升级。 确保集群内流量仅限于名称空间或仅撤销对集群内其他应用程序的Dashboard访问。</p>
</blockquote>
<h3><span id="kubernetes-dashboard-介绍"> kubernetes dashboard 介绍</span></h3>
<h4><span id="最小权限原则"> 最小权限原则</span></h4>
<p><a href="https://github.com/kubernetes/dashboard/wiki/Access-control#default-dashboard-privileges" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/wiki/Access-control#default-dashboard-privileges</a><br>
V1.8<br>
在创建kubernetes-dashboard-key-holder秘密所需的kube-system名称空间中创建秘密权限。<br>
get ， update和delete kube-system名称空间中名为kubernetes-dashboard-key-holder和kubernetes-dashboard-certs秘密的权限。<br>
get和update kube-system名称空间中名为kubernetes-dashboard-settings配置映射的权限。<br>
proxy权限，以允许从heapster获取指标所需的kube-system名称空间中的heapster服务。</p>
<h4><span id="认证方式"> 认证方式</span></h4>
<p><a href="https://github.com/kubernetes/dashboard/wiki/Access-control#authentication" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/wiki/Access-control#authentication</a><br>
从版本1.7开始，仪表板支持基于以下用户的身份验证：<br>
Authorization: Bearer <token>每个请求传递给仪表板的 Authorization: Bearer <token>标头。 从版本1.6开始支持。 具有最高优先级。 如果存在，登录视图将不会显示。<br>
可以在仪表板登录视图上使用的无记名令牌 。<br>
可在仪表板登录视图上使用的用户名/密码 。<br>
可在仪表板登录视图中使用的Kubeconfig文件。</token></token></p>
<p>下面的认证，我们采用 Authorization: Bearer <token>  配合 http 方式。</token></p>
<h5><span id="authorization-header-认证方式介绍"> Authorization header 认证方式介绍</span></h5>
<p><a href="https://github.com/kubernetes/dashboard/wiki/Access-control#authorization-header" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/wiki/Access-control#authorization-header</a><br>
<a href="https://kubernetes.io/docs/admin/authentication/#service-account-tokens" target="_blank" rel="noopener">https://kubernetes.io/docs/admin/authentication/#service-account-tokens</a><br>
使用Authorization header是使Dashboard在通过HTTP访问时充当用户的唯一方式。 请注意，由于普通HTTP流量易受MITM攻击，因此存在一些风险。<br>
要使仪表板使用Authorization header，只需将每个请求中的  Authorization: Bearer <token>  传递给仪表板。 这可以通过在仪表板前配置反向代理来实现。 代理将负责身份提供者身份验证，并将请求头中生成的令牌传递给仪表板。<br>
反向代理 配置 proxy_set_header Authorization &quot;Bearer <token>&quot;;</token></token></p>
<h4><span id="kubernetes-dashboard-安装方式"> kubernetes dashboard 安装方式</span></h4>
<p><a href="https://github.com/kubernetes/dashboard/wiki/Installation" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/wiki/Installation</a><br>
两种安装方式：<a href="https://github.com/kubernetes/dashboard/wiki/Installation#recommended-setup" target="_blank" rel="noopener">使用有效证书建立安全的HTTPS连接方式</a>（官方推荐方式），以及<a href="https://github.com/kubernetes/dashboard/wiki/Installation#alternative-setup" target="_blank" rel="noopener">不使用证书并且Dashboard只通过HTTP公开的方式</a>。<br>
考虑到HTTPS连接方式 中复杂的 RBAC 权限控制，这里考虑使用 HTTP 方式部署dashboard，前端使用nginx proxy 配置用户和权限。</p>
<h3><span id="kubernetes-dashboard-部署"> kubernetes dashboard 部署</span></h3>
<p><a href="https://github.com/kubernetes/dashboard/wiki/Installation#alternative-setup" target="_blank" rel="noopener">不使用证书并且Dashboard只通过HTTP公开的方式</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/alternative/kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<p>kubernetes-dashboard.yaml文件中的ServiceAccount kubernetes-dashboard遵循的是最小权限原则，<br>
因此我们需要创建一个kubernetes-dashboard-admin的ServiceAccount并授予集群admin的权限，创建kubernetes-dashboard-admin.rbac.yaml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># cat kubernetes-dashboard-admin.rbac.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  </span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kubernetes-dashboard-admin.rbac.yaml</span><br></pre></td></tr></table></figure>
<p>查看kubernete-dashboard-admin的token:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 k8srpm]# kubectl -n kube-system get secret | grep kubernetes-dashboard-admin</span><br><span class="line">kubernetes-dashboard-admin-token-s5jmv           kubernetes.io/service-account-token   3         1h</span><br><span class="line">[root@docker01 k8srpm]# kubectl -n kube-system describe secret kubernetes-dashboard-admin-token-s5jmv </span><br><span class="line">Name:         kubernetes-dashboard-admin-token-s5jmv</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name=kubernetes-dashboard-admin</span><br><span class="line">              kubernetes.io/service-account.uid=03b1f483-3195-11e8-87de-0026b954b21d</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1025 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc（后面的省略了）</span><br></pre></td></tr></table></figure>
<p>创建 nginx proxy kubernete-dashboard deployment：<br>
首先创建 nginx配置文件 configmap，在其中定义一个default.conf文件 ：<br>
通过 nginx default.conf， 可以定义允许执行哪些操作(GET/PUT/DELETE/),以及具体的操作路径，或者添加用户认证等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># cat nginx-proxy-kubernetes-dashboard-configmap.conf </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-proxy-kubernetes-dashboard-default.conf </span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  default.conf: |</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        server kubernetes-dashboard:80 ;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">    map $request_method $allowed &#123;</span><br><span class="line">            default deny;</span><br><span class="line">            GET allow;</span><br><span class="line">            # PUT allow;</span><br><span class="line">            # DELETE allow;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">    </span><br><span class="line">        location / &#123;</span><br><span class="line">            if ( $allowed = &quot;deny&quot;) &#123; return 405; &#125;</span><br><span class="line"></span><br><span class="line">            set $flag 0;</span><br><span class="line">            if ( $request_method = &quot;DELETE&quot;) &#123; set $flag &quot;$&#123;flag&#125;1&quot;; &#125;</span><br><span class="line">            if ( $uri !~ &quot;^/api/v1/_raw/pod/.*$&quot; ) &#123; set $flag &quot;$&#123;flag&#125;2&quot;; &#125;</span><br><span class="line">            if ( $flag = &quot;012&quot; )&#123; return 405; &#125;</span><br><span class="line"></span><br><span class="line">            proxy_pass http://backend;</span><br><span class="line">            proxy_set_header Authorization &quot;Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc（后面的省略了）&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>然后，部署nginx deployment</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-proxy-kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-proxy-kubernetes-dashboard</span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-proxy-kubernetes-dashboard-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-proxy-kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-proxy-kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      namespace: kube-system</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-proxy-kubernetes-dashboard</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: default-conf</span><br><span class="line">          mountPath: /etc/nginx/conf.d/</span><br><span class="line">          readOnly: true</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /metrics</span><br><span class="line">            port: 80</span><br><span class="line">          initialDelaySeconds: 15</span><br><span class="line">          periodSeconds: 60</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /metrics</span><br><span class="line">            port: 80</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          periodSeconds: 300</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 2</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">        - name: private-docker-harbor-images-pull</span><br><span class="line">      volumes:</span><br><span class="line">        - name: default-conf</span><br><span class="line">          configMap:</span><br><span class="line">            name: nginx-proxy-kubernetes-dashboard-default.conf </span><br><span class="line">            items:</span><br><span class="line">            - key: default.conf</span><br><span class="line">              path: default.conf</span><br></pre></td></tr></table></figure>
<p>加载配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx-proxy-kubernetes-dashboard-configmap.conf  </span><br><span class="line">kubectl apply -f nginx-proxy-kubernetes-dashboard-deployment.conf</span><br></pre></td></tr></table></figure>
<p>查看状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl  -n kube-system get pod -o wide | grep nginx</span><br><span class="line">nginx-proxy-kubernetes-dashboard-deployment-86df98cb56-w8qwj   1/1       Running   0          5m        10.42.1.9      docker03</span><br><span class="line"># kubectl  -n kube-system get svc | grep nginx</span><br><span class="line">nginx-proxy-kubernetes-dashboard   NodePort    10.108.161.225   &lt;none&gt;        80:31883/TCP    1h</span><br></pre></td></tr></table></figure>
<p>通过 NodePort 访问 kubernetes-dashboard<br>
<a href="http://192.168.0.31:31883" target="_blank" rel="noopener">http://192.168.0.31:31883</a></p>
<p>kubernetes-dashboard 配置完毕</p>
<h2><span id="监控插件-heapster-安装"> 监控插件 heapster 安装</span></h2>
<blockquote>
<p>Heapster为 Kubernetes（版本v1.0.6和更高版本）以及包含它的平台启用容器集群监控和性能分析。<br>
Heapster支持多种数据源和存储后端。 github 位置： <a href="https://github.com/kubernetes/heapster/tree/master/deploy" target="_blank" rel="noopener">https://github.com/kubernetes/heapster/tree/master/deploy</a><br>
heapster 分两种部署方式，一种带存储后端及展示前端，一种是单独安装 heapster。<br>
下面 是 两种方式的安装部署：（任选一种部署即可）</p>
</blockquote>
<h3><span id="在-kubernetes-中部署heapster"> 在 Kubernetes 中部署heapster</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rbac/heapster-rbac.yaml 角色权限</span><br><span class="line">influxdb/influxdb.yaml 存储后端</span><br><span class="line">influxdb/heapster.yaml heapster主服务</span><br><span class="line">influxdb/grafana.yaml 前端展示</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/heapster</span><br><span class="line">cd ~/heapster</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/rbac/heapster-rbac.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/influxdb.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/heapster.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/grafana.yaml</span><br><span class="line">kubectl apply -f ~/heapster</span><br></pre></td></tr></table></figure>
<h3><span id="独立部署-heapster"> 独立部署 heapster</span></h3>
<p>如果不需要 grafana 和 influxdb ，可以单独部署 heapster</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/heapster_standalone</span><br><span class="line">cd ~/heapster_standalone</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/rbac/heapster-rbac.yaml</span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/standalone/heapster-controller.yaml</span><br><span class="line">kubectl apply -f ~/heapster_standalone</span><br></pre></td></tr></table></figure>
<p>确认所有的pod都处于running状态，打开Dashboard,集群的使用统计会以仪表盘的形式显示出来</p>
<h2><span id="使用træfik作为kubernetes集群的ingress控制器"> 使用Træfik作为Kubernetes集群的Ingress控制器</span></h2>
<p>代码示例位置： <a href="https://github.com/containous/traefik/tree/master/examples/k8s" target="_blank" rel="noopener">https://github.com/containous/traefik/tree/master/examples/k8s</a></p>
<h3><span id="rbac-访问控制配置"> RBAC 访问控制配置</span></h3>
<blockquote>
<p>为了简单起见，本指南将使用ClusterRoleBinding</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/containous/traefik/master/examples/k8s/traefik-rbac.yaml</span><br></pre></td></tr></table></figure>
<h3><span id="daemonset部署træfik"> DaemonSet部署Træfik</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/containous/traefik/master/examples/k8s/traefik-ds.yaml</span><br><span class="line">修改镜像版本</span><br><span class="line">sed -i &apos;s/image: traefik$/image: traefik:v1.5.4-alpine/&apos; traefik-ds.yaml</span><br><span class="line">kubectl apply -f  traefik-ds.yaml</span><br></pre></td></tr></table></figure>
<p>查看pod、service启动状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@docker01 k8srpm]# kubectl -n kube-system  get pod -o wide | grep traefik     </span><br><span class="line">traefik-ingress-controller-rh6vl                               1/1       Running   0          51s       192.168.0.31   docker03</span><br><span class="line">traefik-ingress-controller-vdmsf                               1/1       Running   0          51s       192.168.0.65   docker01</span><br><span class="line">traefik-ingress-controller-wtn7t                               1/1       Running   0          51s       192.168.0.67   docker02</span><br><span class="line">[root@docker01 k8srpm]# kubectl -n kube-system  get svc | grep traefik </span><br><span class="line">traefik-ingress-service            NodePort    10.100.102.205   &lt;none&gt;        80:30902/TCP,8080:31881/TCP   55s</span><br></pre></td></tr></table></figure>
<p>查看 traefik 管理界面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.0.65:31881</span><br></pre></td></tr></table></figure>
<h3><span id="向群集提交-一个-ingress"> 向群集提交 一个 ingress</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f   https://raw.githubusercontent.com/containous/traefik/master/examples/k8s/ui.yaml</span><br></pre></td></tr></table></figure>
<p>在 /etc/hosts 文件中设置一个条目，将 traefik-ui.minikube 路由到我们的集群。<br>
我们现在应该可以在浏览器中访问traefik-ui.minikube并查看TræfikWeb UI。</p>
<p>为上面的 myip创建一个 ingress，注意修改 namespace</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># cat myip-ingress.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: myip-portal</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: a.b.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: myip</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f  myip-ingress.yaml</span><br></pre></td></tr></table></figure>
<p>再次查看 TræfikWeb UI ，发现已经新增了一个域名<br>
增加 host ，或者在 linux 上使用curl测试访问：默认为wrr 加权轮询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># curl -H &apos;host:a.b.cn&apos; http://192.168.0.65/</span><br><span class="line">HOSTNAME:myip-859c596bbf-228z2 IP:10.42.1.3</span><br><span class="line"># curl -H &apos;host:a.b.cn&apos; http://192.168.0.65/</span><br><span class="line">HOSTNAME:myip-859c596bbf-4jdvg IP:10.42.0.3</span><br><span class="line"># curl -H &apos;host:a.b.cn&apos; http://192.168.0.65/</span><br><span class="line">HOSTNAME:myip-859c596bbf-vnt82 IP:10.42.2.2</span><br></pre></td></tr></table></figure>
<h3><span id="添加认证"> 添加认证</span></h3>
<p>生成密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># htpasswd -c ./auth admin</span><br><span class="line"># cat auth</span><br><span class="line">admin:$apr1$V92e8PWE$DuOCneYOHY/D9h35cZE/S/</span><br></pre></td></tr></table></figure>
<p>为密码创建secret</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic secret4myip --from-file auth --namespace=default</span><br></pre></td></tr></table></figure>
<p>将以下注释附加到Ingress对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ingress.kubernetes.io/auth-type: &quot;basic&quot;</span><br><span class="line">ingress.kubernetes.io/auth-secret: &quot;secret4myip&quot;</span><br></pre></td></tr></table></figure>
<p>完整示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># cat myip-ingress.yaml </span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: myip-portal</span><br><span class="line">  namespace: default</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">    ingress.kubernetes.io/auth-type: &quot;basic&quot;</span><br><span class="line">    ingress.kubernetes.io/auth-secret: &quot;secret4myip&quot;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: a.b.cn</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: myip</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f  myip-ingress.yaml</span><br></pre></td></tr></table></figure>
<p>再次访问</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># curl -H &apos;host:a.b.cn&apos; http://192.168.0.65/</span><br><span class="line">401 Unauthorized</span><br><span class="line"># curl -H &apos;host:a.b.cn&apos; -u admin:admin http://192.168.0.65/</span><br><span class="line">HOSTNAME:myip-859c596bbf-228z2 IP:10.42.1.3</span><br></pre></td></tr></table></figure>
<p>traefik-dashboard 如下</p>
<img src="/2018/03/28/K8s19-cluster/traefik-dashboard.png" title="traefik-dashboard.png">
<h2><span id="参考资料"> 参考资料</span></h2>
<ul>
<li>官方文档： <a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">Using kubeadm to Create a Cluster</a></li>
<li>关于集群网络的选择安装 <a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network" target="_blank" rel="noopener">Installing a pod network</a></li>
<li>使用kubeadm 部署 kube-router <a href="https://github.com/cloudnativelabs/kube-router/blob/master/Documentation/kubeadm.md" target="_blank" rel="noopener">Deploying kube-router with kubeadm</a></li>
<li>kube-router github地址 <a href="https://github.com/cloudnativelabs/kube-router" target="_blank" rel="noopener">https://github.com/cloudnativelabs/kube-router</a></li>
<li>Kube-router IPVS，网络路由控制，网络策略控制，<a href="https://www.kubernetes.org.cn/3360.html" target="_blank" rel="noopener">中文翻译文档</a></li>
<li><a href="https://www.kubernetes.org.cn/3536.html" target="_blank" rel="noopener">Kubeadm HA 1.9 高可用 集群 本地离线部署</a></li>
<li><a href="https://blog.frognew.com/2017/09/kubeadm-install-kubernetes-1.8.html" target="_blank" rel="noopener">使用kubeadm安装Kubernetes 1.8</a></li>
<li>kubernetes dashboard 访问控制 <a href="https://github.com/kubernetes/dashboard/wiki/Access-control" target="_blank" rel="noopener">kubernetes/dashboard Access control</a></li>
<li>kubernetes/dashboard 权限 <a href="https://github.com/kubernetes/dashboard/wiki/Access-control#default-dashboard-privileges" target="_blank" rel="noopener">最小权限原则  </a></li>
<li>kubernetes/dashboard 认证方式 <a href="https://github.com/kubernetes/dashboard/wiki/Access-control#authentication" target="_blank" rel="noopener">仪表板支持几种用户的身份验证</a></li>
<li>kubernetes/dashboard 认证方式 <a href="https://github.com/kubernetes/dashboard/wiki/Access-control#authorization-header" target="_blank" rel="noopener">Authorization header </a></li>
<li>kubernetes/dashboard https <a href="https://github.com/kubernetes/dashboard/wiki/Installation#recommended-setup" target="_blank" rel="noopener">方式安装 </a></li>
<li>kubernetes/dashboard http  <a href="https://github.com/kubernetes/dashboard/wiki/Installation#alternative-setup" target="_blank" rel="noopener">方式安装 </a></li>
<li>Træfik for Kubernetes Ingress Controller  <a href="https://docs.traefik.io/user-guide/kubernetes/" target="_blank" rel="noopener">Kubernetes Ingress Controller</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.2" async></script><a class="article-share-link" data-url="yunke.science/2018/03/28/K8s19-cluster/" data-id="cjgaqme85000drw0vqcggtk0a" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABxElEQVR42u3ay47CMAwFUP7/pxmJFdIMcG0nKSOdrFCL0tMuLD9yu8Xr/ljPv59Xfv3VlcULFxd3zL2/Xb+5vX2S/d//BxcX9zx3HrwmnyAx4OLific3SYCqWQouLu5/5+YBa9XnwMXFvZY7KU6qpU6SQi2o1XBxcQfcXsN07e/t/V1cXNxFU4leKyRPYspPx8XFPcJNHvP+AZNhTDKIjXowuLi427j5cYr8lXoN1g+pDy4u7kHuqlFHdZiaN01wcXHPcPclItUgWK7VcHFxt3Gr49Le1tW7zRIIFxd3KXfV0DQ/hlU93oGLi3uem7cz5kVOvk+hl4OLi7uUmw9FegcyekPZcq2Gi4u7jTtPQXrDmELLFRcX9yJuPoFJGhm9QctLAy4u7hFuNSmZNEzzYcyHF8DFxd3MraYg1ZFqDo0KLVxc3IPcamqSFzzl45hJIMPFxT3CrY5UF2RV8Sf4IxfDxcXdzM1XNVT1mq35XVxc3N3cPHhVS6BqeyUKlLi4uAe51eDVK4FGxQ8uLu5XcpNjVTmul/rg4uJ+J7fX8ujthouLey231yTNr1SHKwtqNVxc3GnGUm6Y9lKZahDExcU9zv0B12Zi6UPZn78AAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/Kubernetes/">Kubernetes</a><a href="/tags/docker/">docker</a></div><div class="post-nav"><a class="pre" href="/2018/03/30/Calico4k8s/">Quickstart for Calico on Kubernetes</a><a class="next" href="/2018/03/28/Ingress-traefik/">Kubernetes Ingress Controller traefik</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.2"><script src="/js/gitment.browser.js?v=0.0.2"></script><script>var gitment = new Gitment({
  owner: 'young-0',
  repo: 'young-0.github.io',
  oauth: {
    client_id: '967eeda5599f16063a0a',
    client_secret: '0c5aaeec2649210043608d7a09c7d19f0795f3f9',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="yunke.science"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kubernetes/">Kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/elk/">elk</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/fiction/">fiction</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/monitor/">monitor</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/美文/">美文</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/elk/" style="font-size: 15px;">elk</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/traefik/" style="font-size: 15px;">traefik</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/openresty/" style="font-size: 15px;">openresty</a> <a href="/tags/LuaRocks/" style="font-size: 15px;">LuaRocks</a> <a href="/tags/Kubernetes/" style="font-size: 15px;">Kubernetes</a> <a href="/tags/monitor/" style="font-size: 15px;">monitor</a> <a href="/tags/crond/" style="font-size: 15px;">crond</a> <a href="/tags/alpine/" style="font-size: 15px;">alpine</a> <a href="/tags/网络/" style="font-size: 15px;">网络</a> <a href="/tags/kcptun/" style="font-size: 15px;">kcptun</a> <a href="/tags/zabbix/" style="font-size: 15px;">zabbix</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/fiction/" style="font-size: 15px;">fiction</a> <a href="/tags/美文/" style="font-size: 15px;">美文</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/04/22/zabbix-depend/">zabbix 3.4 新特性：从属监控项</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/22/kcptun4zabbix/">使用kcptun建立UDP隧道传输数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/20/zabbix-macros/">zabbix 宏概念及使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/20/ip-netmaster/">ip 子网划分的两个例子</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/19/meiwen01/">凡是让人幸福的东西，往往又会成为他不幸的源泉。</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/19/madeofmeat/">THEY'RE MADE OUT OF MEAT (他们是肉造的！)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/JSONPath/">kubectl 的 JSONPath 查询支持</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/15/k8s-hook/">使用k8s容器钩子确保服务安全退出</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/14/docker-notions/">Docker 基本概念</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/09/Tini-command/">Tini - 一个小而有效的容器初始化命令</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.21andy.com/manual/advanced-bash-scripting-guide/" title="高级Bash脚本编程指南" target="_blank">高级Bash脚本编程指南</a><ul></ul><a href="http://www.colasoft.com.cn/training/document.php" title="网络分析技术学习资料" target="_blank">网络分析技术学习资料</a><ul></ul><a href="https://k8smeetup.github.io/docs/home/" title="Kubernetes 文档" target="_blank">Kubernetes 文档</a><ul></ul><a href="https://www.bilibili.com/video/av21179285" title="TCPIP协议详解" target="_blank">TCPIP协议详解</a><ul></ul><a href="https://www.bilibili.com/video/av21540971" title="python数据结构与算法系列课程" target="_blank">python数据结构与算法系列课程</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">天青色等烟雨  而我在等你.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.2" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.2" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zIndex="-2" count="50" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.2"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.2"></script></div></body></html>